{"version":3,"names":["useMemo","useCallback","useEffect","useState","useRef","Fragment","autop","plusCircle","Icon","debounce","classnames","Transforms","ReactEditor","createEditor","deserialize","serialize","RichTextEditor","RichTextControlRenderer","id","value","setValue","mergeTags","className","allowedFormats","focusOnMount","placeholder","isReady","setIsReady","jsonVal","setJsonVal","type","children","text","currentSelection","setCurrentSelection","path","offset","editor","isMounted","current","serializeVal","newVal","onChange","selection","focus","setTimeout","length","TextEditor","createElement","onFocus","JSON","stringify","icon","onClick","e","stopPropagation","insertText","at","select","move","unit"],"sources":["@quillforms/admin-components/src/rich-text/components/richtext-control/renderer.tsx"],"sourcesContent":["/**\n * WordPress Dependencies\n */\nimport {\n\tuseMemo,\n\tuseCallback,\n\tuseEffect,\n\tuseState,\n\tuseRef,\n\tFragment,\n} from 'react';\nimport { autop } from '@wordpress/autop';\nimport { plusCircle } from '@wordpress/icons';\nimport { Icon } from '@wordpress/components';\n\n/**\n * External Dependencies\n */\nimport { debounce } from 'lodash';\nimport classnames from 'classnames';\nimport { Transforms, Node } from 'slate';\nimport { HistoryEditor } from 'slate-history';\nimport { ReactEditor } from 'slate-react';\n\n/**\n * Internal Dependencies\n */\nimport createEditor from '../../create-editor';\nimport deserialize from '../../html-deserialize';\nimport serialize from '../../html-serialize';\nimport RichTextEditor from '../editor';\nimport { allowedFormats, CustomNode, MergeTags } from '../../types';\n\ninterface Props {\n\tvalue: string;\n\tid?: string;\n\tsetValue: ( value: string ) => void;\n\tmergeTags?: MergeTags;\n\tclassName?: string;\n\tallowedFormats?: allowedFormats;\n\tfocusOnMount?: boolean;\n\tplaceholder?: string;\n}\nconst RichTextControlRenderer: React.FC< Props > = ( {\n\tid,\n\tvalue,\n\tsetValue,\n\tmergeTags,\n\tclassName,\n\tallowedFormats,\n\tfocusOnMount = false,\n\tplaceholder,\n} ) => {\n\tconst [ isReady, setIsReady ] = useState( false );\n\tconst [ jsonVal, setJsonVal ] = useState< CustomNode[] >( [\n\t\t{\n\t\t\ttype: 'paragraph',\n\t\t\tchildren: [\n\t\t\t\t{\n\t\t\t\t\ttext: '',\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t] );\n\n\tconst [ currentSelection, setCurrentSelection ] = useState( {\n\t\tpath: [ 0, 0 ],\n\t\toffset: 0,\n\t} );\n\n\tconst editor: ReactEditor & HistoryEditor = useMemo(\n\t\t() => createEditor(),\n\t\t[ id, isReady ]\n\t);\n\n\tconst isMounted = useRef( false );\n\tuseEffect( () => {\n\t\tisMounted.current = true;\n\t\treturn () => {\n\t\t\tisMounted.current = false;\n\t\t};\n\t}, [] );\n\n\t// serializeVal is a debounced function that updates the store with serialized html value\n\tconst serializeVal = useCallback(\n\t\tdebounce( ( newVal ) => {\n\t\t\tif ( isMounted.current ) {\n\t\t\t\tsetValue( serialize( newVal ) );\n\t\t\t}\n\t\t}, 200 ),\n\t\t[]\n\t);\n\n\tconst onChange = ( newVal: Node[] ) => {\n\t\tif ( editor.selection ) {\n\t\t\tsetCurrentSelection( {\n\t\t\t\tpath: editor.selection.focus.path,\n\t\t\t\toffset: editor.selection.focus.offset,\n\t\t\t} );\n\t\t}\n\t\tsetJsonVal( newVal );\n\t\tserializeVal( newVal );\n\t};\n\n\t// Deserialize value on mount.\n\tuseEffect( () => {\n\t\tif ( focusOnMount ) {\n\t\t\tsetTimeout( () => {\n\t\t\t\tReactEditor.focus( editor );\n\t\t\t}, 0 );\n\t\t}\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tsetIsReady( false );\n\t\tsetJsonVal( deserialize( autop( value ) ) );\n\t\tsetIsReady( true );\n\t}, [ mergeTags?.length ] );\n\n\tconst TextEditor = useMemo(\n\t\t() => (\n\t\t\t<RichTextEditor\n\t\t\t\tvalue={ jsonVal }\n\t\t\t\teditor={ editor }\n\t\t\t\tonChange={ onChange }\n\t\t\t\tmergeTags={ mergeTags }\n\t\t\t\tonFocus={ () => {\n\t\t\t\t\tif ( editor.selection ) {\n\t\t\t\t\t\tsetCurrentSelection( {\n\t\t\t\t\t\t\tpath: editor.selection.focus.path,\n\t\t\t\t\t\t\toffset: editor.selection.focus.offset,\n\t\t\t\t\t\t} );\n\t\t\t\t\t}\n\t\t\t\t} }\n\t\t\t\tallowedFormats={ allowedFormats }\n\t\t\t\tplaceholder={ placeholder }\n\t\t\t/>\n\t\t),\n\t\t[ isReady, JSON.stringify( jsonVal ), JSON.stringify( mergeTags ) ]\n\t);\n\n\tif ( ! isReady ) return null;\n\n\treturn (\n\t\t<div className={ classnames( 'rich-text-control', className ) }>\n\t\t\t<Fragment>\n\t\t\t\t{ TextEditor }\n\t\t\t\t{ mergeTags && mergeTags.length > 0 && (\n\t\t\t\t\t<Fragment>\n\t\t\t\t\t\t<div className=\"rich-text-control__add-merge-tags\">\n\t\t\t\t\t\t\t<Icon\n\t\t\t\t\t\t\t\ticon={ plusCircle }\n\t\t\t\t\t\t\t\t// @ts-expect-error\n\t\t\t\t\t\t\t\tonClick={ ( e: MouseEvent ) => {\n\t\t\t\t\t\t\t\t\te.stopPropagation();\n\n\t\t\t\t\t\t\t\t\tTransforms.insertText( editor, '@', {\n\t\t\t\t\t\t\t\t\t\tat: currentSelection,\n\t\t\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t\t\t\tsetTimeout( () => {\n\t\t\t\t\t\t\t\t\t\tTransforms.select(\n\t\t\t\t\t\t\t\t\t\t\teditor,\n\t\t\t\t\t\t\t\t\t\t\tcurrentSelection\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\tReactEditor.focus( editor );\n\t\t\t\t\t\t\t\t\t\tTransforms.move( editor, {\n\t\t\t\t\t\t\t\t\t\t\tunit: 'character',\n\t\t\t\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t\t\t\t}, 0 );\n\t\t\t\t\t\t\t\t} }\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</Fragment>\n\t\t\t\t) }\n\t\t\t</Fragment>\n\t\t</div>\n\t);\n};\nexport default RichTextControlRenderer;\n"],"mappings":"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","ignoreList":[]}
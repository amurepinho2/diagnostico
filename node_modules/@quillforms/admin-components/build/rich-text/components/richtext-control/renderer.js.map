{"version":3,"names":["_react","require","_autop","_icons","_components","_lodash","_classnames","_interopRequireDefault","_slate","_slateReact","_createEditor","_htmlDeserialize","_htmlSerialize","_editor","RichTextControlRenderer","id","value","setValue","mergeTags","className","allowedFormats","focusOnMount","placeholder","isReady","setIsReady","useState","jsonVal","setJsonVal","type","children","text","currentSelection","setCurrentSelection","path","offset","editor","useMemo","createEditor","isMounted","useRef","useEffect","current","serializeVal","useCallback","debounce","newVal","serialize","onChange","selection","focus","setTimeout","ReactEditor","deserialize","autop","length","TextEditor","createElement","default","onFocus","JSON","stringify","classnames","Fragment","Icon","icon","plusCircle","onClick","e","stopPropagation","Transforms","insertText","at","select","move","unit","_default","exports"],"sources":["@quillforms/admin-components/src/rich-text/components/richtext-control/renderer.tsx"],"sourcesContent":["/**\n * WordPress Dependencies\n */\nimport {\n\tuseMemo,\n\tuseCallback,\n\tuseEffect,\n\tuseState,\n\tuseRef,\n\tFragment,\n} from 'react';\nimport { autop } from '@wordpress/autop';\nimport { plusCircle } from '@wordpress/icons';\nimport { Icon } from '@wordpress/components';\n\n/**\n * External Dependencies\n */\nimport { debounce } from 'lodash';\nimport classnames from 'classnames';\nimport { Transforms, Node } from 'slate';\nimport { HistoryEditor } from 'slate-history';\nimport { ReactEditor } from 'slate-react';\n\n/**\n * Internal Dependencies\n */\nimport createEditor from '../../create-editor';\nimport deserialize from '../../html-deserialize';\nimport serialize from '../../html-serialize';\nimport RichTextEditor from '../editor';\nimport { allowedFormats, CustomNode, MergeTags } from '../../types';\n\ninterface Props {\n\tvalue: string;\n\tid?: string;\n\tsetValue: ( value: string ) => void;\n\tmergeTags?: MergeTags;\n\tclassName?: string;\n\tallowedFormats?: allowedFormats;\n\tfocusOnMount?: boolean;\n\tplaceholder?: string;\n}\nconst RichTextControlRenderer: React.FC< Props > = ( {\n\tid,\n\tvalue,\n\tsetValue,\n\tmergeTags,\n\tclassName,\n\tallowedFormats,\n\tfocusOnMount = false,\n\tplaceholder,\n} ) => {\n\tconst [ isReady, setIsReady ] = useState( false );\n\tconst [ jsonVal, setJsonVal ] = useState< CustomNode[] >( [\n\t\t{\n\t\t\ttype: 'paragraph',\n\t\t\tchildren: [\n\t\t\t\t{\n\t\t\t\t\ttext: '',\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t] );\n\n\tconst [ currentSelection, setCurrentSelection ] = useState( {\n\t\tpath: [ 0, 0 ],\n\t\toffset: 0,\n\t} );\n\n\tconst editor: ReactEditor & HistoryEditor = useMemo(\n\t\t() => createEditor(),\n\t\t[ id, isReady ]\n\t);\n\n\tconst isMounted = useRef( false );\n\tuseEffect( () => {\n\t\tisMounted.current = true;\n\t\treturn () => {\n\t\t\tisMounted.current = false;\n\t\t};\n\t}, [] );\n\n\t// serializeVal is a debounced function that updates the store with serialized html value\n\tconst serializeVal = useCallback(\n\t\tdebounce( ( newVal ) => {\n\t\t\tif ( isMounted.current ) {\n\t\t\t\tsetValue( serialize( newVal ) );\n\t\t\t}\n\t\t}, 200 ),\n\t\t[]\n\t);\n\n\tconst onChange = ( newVal: Node[] ) => {\n\t\tif ( editor.selection ) {\n\t\t\tsetCurrentSelection( {\n\t\t\t\tpath: editor.selection.focus.path,\n\t\t\t\toffset: editor.selection.focus.offset,\n\t\t\t} );\n\t\t}\n\t\tsetJsonVal( newVal );\n\t\tserializeVal( newVal );\n\t};\n\n\t// Deserialize value on mount.\n\tuseEffect( () => {\n\t\tif ( focusOnMount ) {\n\t\t\tsetTimeout( () => {\n\t\t\t\tReactEditor.focus( editor );\n\t\t\t}, 0 );\n\t\t}\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tsetIsReady( false );\n\t\tsetJsonVal( deserialize( autop( value ) ) );\n\t\tsetIsReady( true );\n\t}, [ mergeTags?.length ] );\n\n\tconst TextEditor = useMemo(\n\t\t() => (\n\t\t\t<RichTextEditor\n\t\t\t\tvalue={ jsonVal }\n\t\t\t\teditor={ editor }\n\t\t\t\tonChange={ onChange }\n\t\t\t\tmergeTags={ mergeTags }\n\t\t\t\tonFocus={ () => {\n\t\t\t\t\tif ( editor.selection ) {\n\t\t\t\t\t\tsetCurrentSelection( {\n\t\t\t\t\t\t\tpath: editor.selection.focus.path,\n\t\t\t\t\t\t\toffset: editor.selection.focus.offset,\n\t\t\t\t\t\t} );\n\t\t\t\t\t}\n\t\t\t\t} }\n\t\t\t\tallowedFormats={ allowedFormats }\n\t\t\t\tplaceholder={ placeholder }\n\t\t\t/>\n\t\t),\n\t\t[ isReady, JSON.stringify( jsonVal ), JSON.stringify( mergeTags ) ]\n\t);\n\n\tif ( ! isReady ) return null;\n\n\treturn (\n\t\t<div className={ classnames( 'rich-text-control', className ) }>\n\t\t\t<Fragment>\n\t\t\t\t{ TextEditor }\n\t\t\t\t{ mergeTags && mergeTags.length > 0 && (\n\t\t\t\t\t<Fragment>\n\t\t\t\t\t\t<div className=\"rich-text-control__add-merge-tags\">\n\t\t\t\t\t\t\t<Icon\n\t\t\t\t\t\t\t\ticon={ plusCircle }\n\t\t\t\t\t\t\t\t// @ts-expect-error\n\t\t\t\t\t\t\t\tonClick={ ( e: MouseEvent ) => {\n\t\t\t\t\t\t\t\t\te.stopPropagation();\n\n\t\t\t\t\t\t\t\t\tTransforms.insertText( editor, '@', {\n\t\t\t\t\t\t\t\t\t\tat: currentSelection,\n\t\t\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t\t\t\tsetTimeout( () => {\n\t\t\t\t\t\t\t\t\t\tTransforms.select(\n\t\t\t\t\t\t\t\t\t\t\teditor,\n\t\t\t\t\t\t\t\t\t\t\tcurrentSelection\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\tReactEditor.focus( editor );\n\t\t\t\t\t\t\t\t\t\tTransforms.move( editor, {\n\t\t\t\t\t\t\t\t\t\t\tunit: 'character',\n\t\t\t\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t\t\t\t}, 0 );\n\t\t\t\t\t\t\t\t} }\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</Fragment>\n\t\t\t\t) }\n\t\t\t</Fragment>\n\t\t</div>\n\t);\n};\nexport default RichTextControlRenderer;\n"],"mappings":"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","ignoreList":[]}
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.sanitizeBlockAttributes = sanitizeBlockAttributes;
exports.sanitizeBlocks = void 0;
var _lodash = require("lodash");
var _registration = require("./registration");
/**
 * External Dependencies
 */

/**
 * Internal Dependencies
 */

function sanitizeBlockAttributes(blockName, attributes) {
  // Get the block type
  const blockType = (0, _registration.getBlockType)(blockName);
  if (undefined === blockType) {
    throw new Error(`Block type '${blockName}' is not registered.`);
  }
  // Ensure attributes contains only values defined by block type, and merge
  // default values for missing attributes.
  return (0, _lodash.reduce)(blockType.attributes, (accumulator, schema, key) => {
    const value = attributes[key];
    if (undefined !== value) {
      accumulator[key] = value;
    } else if (schema.hasOwnProperty('default')) {
      accumulator[key] = schema.default;
    }
    return accumulator;
  }, {});
}

/**
 * Sanitize blocks
 * Transform unknwon blocks and sanitize block attributes
 *
 * @param {FormBlocks} blocks The form blocks to be sanitized
 *
 * @return {FormBlocks} The sanitized blocks
 */
const sanitizeBlocks = blocks => {
  if ((0, _lodash.isEmpty)(blocks)) {
    return [];
  }
  return (0, _lodash.map)(blocks, block => {
    if ((0, _registration.getBlockType)(block.name)) {
      if (typeof block?.innerBlocks !== 'undefined' && (0, _lodash.size)(block?.innerBlocks) > 0) {
        return {
          ...block,
          attributes: sanitizeBlockAttributes(block.name, block.attributes ? block.attributes : {}),
          innerBlocks: sanitizeBlocks(block.innerBlocks)
        };
      }
      return {
        ...block,
        attributes: sanitizeBlockAttributes(block.name, block.attributes ? block.attributes : {})
      };
    }
    return {
      ...block,
      name: 'unknown',
      attributes: sanitizeBlockAttributes('unknown', block.attributes ? block.attributes : {})
    };
  });
};
exports.sanitizeBlocks = sanitizeBlocks;
//# sourceMappingURL=utils.js.map